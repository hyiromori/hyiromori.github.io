---
title: "OAuth2.0の流れをまとめてみる"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["OAuth2"]
published: false
---

# はじめに

最近、個人的に認証認可周りを学習していて、その過程でOAuth2.0について学習している内容をまとめた記事です。

世の中には既にOAuth2に関する優れた書籍やブログ記事が沢山ありますが、自分が学習する過程で色々なものを読むことでより理解が深まったと思うので、自分も学習したものをアウトプットすることで同じように学習している人の理解の助けになればと思って公開します。

まだ私も学習中なので、もし間違ったところなどあればコメント頂けるとありがたいです。

## 注意点

この記事内ではOAuth2.0で定義されているフロー の1つ、認可コードによる付与（Authorization Code Grant）についてまとめています。
たくさんの仕様をいきなり網羅的にまとめるのは難しいので、1つに絞って今回はまとめています。

OAuth2.0に定義されているフローの解説については、こちらの記事が参考になりました。
https://qiita.com/TakahikoKawasaki/items/200951e5b5929f840a1f



# OAuth2.0とは何か？

OAuth2.0は**認可**を行うためのプロトコルで、所有者の代わりにリソースへのアクセスを許可するための手段です。

もう少し具体的に言うと、エンドユーザーがあるサービスに対して別のサービスへのアクセスを許可するためのトークンを発行するために定められた規格という感じです。

## 認証と認可

OAuthは認可のためのプロトコルですが、認証を行うためのプロトコル**ではありません**。

認証と認可の違いについては以下の記事が参考になりました。

https://dev.classmethod.jp/articles/authentication-and-authorization/

また単なるOAuth2.0を認証に使ってしまうと、どういったセキュリティ上のリスクがあるのかは以下の記事が参考になりました。

https://www.sakimura.org/2012/02/1487/

## OpenID Connect

OpenID Connect は OAuth2.0 の拡張規格で、認証を行うこともできるようになっています。
（この辺りについても別の記事でまとめたい）



# OAuth2.0の登場人物

## リソースサーバー

保護対象のリソースを保持しているサーバーを指します。
保護対象のリソースは様々なものがあり一概にこれとは言えませんが、例えばGoogleフォトの画像や、SNSの投稿などをイメージすると分かりやすいかもしれません。

## リソースオーナー

保護対象のリソースを所有している人を指します。
OAuth2.0を使ってアカウントを連携をしたいエンドユーザーと考えると分かりやすいかもしれません。

## クライアント

保護対象のリソースにアクセスするソフトウェアのことを指します。
対象は様々なので一概にこれとは言えませんが、Web開発者であればWebブラウザと考えておくと理解しやすいかもしれません。

## 認可サーバー

リソースサーバーに信頼されたサーバーで、リソースオーナーの認証を行い、リソースサーバーに対するアクセストークンを発行できます。
OAuth2.0において重要な役割を果たすサーバーですね。



# OAuth2.0の流れ

認可コードによる付与（Authorization Code Grant）の流れをまとめます。

なおHTTPリクエストの例は関係する部分以外は省略しています。

## 認可サーバーへのリダイレクト


```http
GET request_authorize HTTP/1.1
Host: https://client.example.com
```

```http
HTTP/1.1 302 Found
Location: https://auth.example.com/authorize?response_type=code&scope=email&client_id=(CLIENT_ID)&redirect_url=https%3A%2F%2Fclient.example.com%2Fcallback&state=(STATE)
```

## 認可サーバーでの認証

`(TODO: 認可のサンプル画面)`

## 認可コードの発行

認証が正常に行われると、アクセストークンを発行するための認可コードを発行して、クライアントへリダイレクトし ます。

```http
HTTP/1.1 302 Found
Location: https://client.example.com/callback?code=(認可コード)&state=(STATE)
```

```http
GET /callback?code=(認可コード)&state=(STATE) HTTP/1.1
Host: https://client.example.com
```

## アクセストークンの発行

認可サーバーのトークンエンドポイントに認可コードを渡して、アクセストークンを取得します。
サーバー間で行われるので、特にユーザーからは見えない処理になります。




# 参考資料

学習する過程で参考になった資料をまとめておきます。

- 書籍: [OAuth徹底入門 セキュアな認可システムを適用するための原則と実践](https://www.amazon.co.jp/dp/4798159298)
- [OAuth 2.0 全フローの図解と動画 - Qiita](https://qiita.com/TakahikoKawasaki/items/200951e5b5929f840a1f)
- [一番分かりやすい OAuth の説明 - Qiita](https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be)
- [OAuth 2.0 全フローの図解と動画 - Qiita](https://qiita.com/TakahikoKawasaki/items/200951e5b5929f840a1f)
