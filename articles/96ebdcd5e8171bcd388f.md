---
title: "AWS API Gateway の WebSocket API をちゃんと理解する"
emoji: "⚡️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "APIGateway", "WebSocket"]
published: false
---

これは [コネヒト Advent Calendar 2020 1日目](https://qiita.com/advent-calendar/2020/connehito) の記事です。

## はじめに

これは AWS のサービスの一つ、[API Gateway](https://aws.amazon.com/jp/api-gateway/) の [WebSocket API](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-websocket-api-overview.html) を理解するために書いた記事です。
[発表当初](https://aws.amazon.com/jp/blogs/news/announcing-websocket-apis-in-amazon-api-gateway/)から個人的に色々試してはいたのですが、一度ちゃんとまとめたいなと思って書いた記事です。



# WebSocket API が提供してくれるもの

## サーバー管理不要で WebSocket コネクションを管理できる

API Gateway が WebSocket の接続から維持、切断までを面倒みてくれます。
EC2などのサーバーを管理しなくても良い、いわゆるサーバーレスなサービスですね。

## コネクションイベントとメッセージ受信時にバックエンドへ送信してくれる

コネクションを管理してくれるだけではなく、WebSocket コネクションが接続された時、切断された時、そしてメッセージを受信した時にバックエンドにイベントを送信してくれます。
バックエンドは [Lambda](https://aws.amazon.com/jp/lambda/) などのAWSサービスはもちろん、`HTTP` での送信もできるので自前のサーバーに送ることもできます。

![API Gateway](https://i.gyazo.com/61fcdc520d1c60e8b146c4dce7de7bcd.png)

またコネクションの接続時、切断時、メッセージ受信時でそれぞれ別のバックエンドを指定できます。
（※更にメッセージ受信時はメッセージの内容で別のバックエンドにすることも可能ですが今回は使いません）

![API Gateway](https://i.gyazo.com/687a28f471123f007c6d9e73081c4517.png)

## WebSocket へメッセージを送信するエンドポイントを提供してくれる

WebSocket API は接続毎にコネクションIDを発行してくれます。
このコネクションIDを指定することで、AWS CLI や SDK で WebSocket に対してメッセージを送信できます。
コネクションIDは接続時、切断時、メッセージ受信時のイベントから取得することができます。
コネクションIDをどのように管理するかは、ユーザーの実装に委ねられています。（一覧APIのようなものは AWS にはありません）



# Serverless Framework を使ったサンプルで WebSocket API をデプロイする

今回は [Serverless Framework](https://www.npmjs.com/package/serverless) を使ってサンプル実装を作りました。
[hyiromori/example-aws-api-gateway-websocket](https://github.com/hyiromori/example-aws-api-gateway-websocket)

動くコードは数十行しかない、ごく小さなプロジェクトです。
これをデプロイして、次の「WebSocket API の実験」を行います。

## サンプルコード解説

軽くサンプル実装について解説します。

コアとなる部分は [index.js](https://github.com/hyiromori/example-aws-api-gateway-websocket/blob/main/index.js) の部分です。
ここにメッセージ受信時、接続時、切断時の処理を実装しています。

まずメッセージ受信時の処理です。
ここでは受信したイベントからエンドポイントURLを組み立てて、コネクションIDと共に送信元に返す処理をしています。
このエンドポイントURLとコネクションIDが、WebSocket にメッセージを送信するために必要になります。

```javascript
const onMessage = async (event) => {
  // イベントデータからコネクションのエンドポイントURLを組み立てる
  const { body } = event
  const {connectionId, apiId, stage} = event.requestContext;
  const endpoint = `https://${apiId}.execute-api.${process.env.AWS_REGION}.amazonaws.com/${stage}`

  // 送信元コネクションにエンドポイントURLとコネクションIDを送信する
  const apiGateway = new ApiGatewayManagementApi({apiVersion: '2018-11-29', endpoint})
  const params = {Data: JSON.stringify({endpoint, connectionId, request: body}), ConnectionId: connectionId}
  await apiGateway.postToConnection(params).promise()

  return {}
}
```

接続時と切断時は特に何もしないので、そのまま正常終了させます。
ちなみに接続時と切断時にもエンドポイントURLを組み立てる情報やコネクションIDは含まれているので、ここで必要な処理を実装することもできます。
（今回の実験では使用しないだけです）

```javascript
const mockHandler = (_event, _context, callback) => callback(null, {})
```

あとは [serverless.yml](https://github.com/hyiromori/example-aws-api-gateway-websocket/blob/main/serverless.yml#L24-L38) で `WebSocket API` のイベントと `Lambda` を紐付けます。

```yaml
onConnect:
  handler: "index.onConnect"
  events:
    - websocket:
        route: "$connect"
onMessage:
  handler: "index.onMessage"
  events:
    - websocket:
        route: "$default"
onDisconnect:
  handler: "index.onDisconnect"
  events:
    - websocket:
        route: "$disconnect"
```

## デプロイ

[AWSアクセスキーを設定](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-configure-files.html) した上で、以下のコマンドを実行するだけで API Gateway の WebSocket API が作成できます。

```bash
$ npm run deploy

(略)
endpoints:
  wss://xxxxxxxxxx.execute-api.(AWS_REGION).amazonaws.com/dev
(略)
```

`wss://....` のURLは、次の「WebSocket API の実験」で使用するのでメモしておきます。

## WebSocket のタイムアウトについて







# WebSocket API の実験

デプロイした WebSocket API を使って、どのような挙動をするか確認します。

## wscat と AWS CLI を使って動作確認してみる

[wscat](https://www.npmjs.com/package/wscat) という WebSocket のクライアントと AWS CLI を使って、簡単に WebSocket API の動作確認をしてみましょう。
先に結果を見せるとこんな感じになります。

![websocket experiment](https://i.gyazo.com/4ad51c9bafc17546825378af16adbc26.gif)

何をやっているか順番に説明します。

まず以下のコマンドで `wscat` を起動して、API Gateway の WebSocket 用のエンドポイントに WebSocket で接続します。
（実際に試す場合は、デプロイ時に出力されたURLを指定してください）

```bash
$ npx wscat -c 'wss://xxxxxxxxxx.execute-api.(AWS_REGION).amazonaws.com/dev'
```

これは WebSocket 経由で `{}` というデータを送信しています。
その後、デプロイした `Lambda` が処理をして、エンドポイントURLとコネクションIDが入ったメッセージ（JSON）を受信しています。

```
> {}
< {"endpoint":"https://lxhspujxjd.execute-api.us-east-1.amazonaws.com/dev","connectionId":"WqK8Ie4IIAMCEdA=","request":"{}"}
```

この受信したエンドポイントURLとコネクションIDを使って、別のターミナルから AWS CLI を使って `{"test":"data"}` というメッセージを送信します。

```bash
$ aws apigatewaymanagementapi post-to-connection \
    --data '{"test":"data"}' \
    --endpoint-url 'https://lxhspujxjd.execute-api.us-east-1.amazonaws.com/dev' \
    --connection-id 'WqK8Ie4IIAMCEdA='
```

そして `wscat` 側で `{"test":"data"}` というメッセージを受信している事がわかります。

```
< {"test":"data"}
```

これで WebSocket 経由でのデータ送受信が確認できました！
ポイントは、エンドポイントURLとコネクションIDがあればメッセージの送信ができるということです。
この２つの情報をどのように管理していくかが実装時に注意していく必要があると思います。



# WebSocket API の料金

WebSocket API は接続時間と、メッセージの送受信量に応じて課金されます

`ap-northeast-1` (Asia/Tokyo) の料金です。
日本円への変換は `$1 = 100円` で計算しています。

最新の正確な料金は以下の公式ドキュメントを確認してください。
[料金 - Amazon API Gateway | AWS](https://aws.amazon.com/jp/api-gateway/pricing/)

## 接続時間に応じた料金

100万分の接続に対して、$0.315かかります。
例えば、１万人のユーザーが、１人あたり月に1000分（約16時間）接続したら、31.5円かかる計算です。
かなり安いですね。

## メッセージの送受信量に応じた料金

メッセージの送受信量は、32KB単位で計算されるようです。
１メッセージを32KB以下であれば、10億回につき$1.26かかります。
例えば、１万人のユーザーが、32KB以下のメッセージを１人あたり月に10万回送受信したら、126円かかる計算です。

なお送受信できる１回のメッセージのサイズは最大128KBです。
