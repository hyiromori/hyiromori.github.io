---
title: "AWS API Gateway の WebSocket API を理解する"
emoji: "⚡️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "APIGateway", "WebSocket"]
published: false
---

## はじめに

これは AWS のサービスの一つ、[API Gateway](https://aws.amazon.com/jp/api-gateway/) の [WebSocket API](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-websocket-api-overview.html) を理解するために書いた記事です。
[発表当初](https://aws.amazon.com/jp/blogs/news/announcing-websocket-apis-in-amazon-api-gateway/)から個人的に色々試してはいたのですが、一度ちゃんとまとめたいなと思って書いた記事です。



# WebSocket API が提供してくれるもの

## サーバー管理不要で WebSocket コネクションを管理できる

EC2インスタンスを立てたりしなくても、API Gateway が WebSocket のコネクションを維持してくれるという感じです。
いわゆるサーバーレスなサービスですね。
（ちなみに AWS の [ALB (Application Load Balancer)](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/application/introduction.html) は WebSocket に対応できるのですが、[NLB (Network Load Balancer)](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/network/introduction.html) は対応できなくて、悔しい思いをしたことがあります）

## コネクションイベントとメッセージ受信時にバックエンドへ送信してくれる

コネクションを維持するだけでは何の意味もありませんね。
当然 WebSocket コネクションが接続された時、切断された時、そしてメッセージを受信した時にバックエンドにイベントを送信してくれます。

バックエンドは [Lambda](https://aws.amazon.com/jp/lambda/) などAWSサービスはもちろん、`HTTP` での送信もできるので自前のサーバーに送ることもできます。

![API Gateway](https://i.gyazo.com/61fcdc520d1c60e8b146c4dce7de7bcd.png)

## コネクションIDを指定して接続されている WebSocket へメッセージ送信してくれる

WebSocket API は接続毎にコネクションIDを発行してくれます。
このコネクションIDを指定することで、AWS CLI や SDK で接続されている WebSocket に対してメッセージを送信できます。
コネクションIDは接続時、切断時、メッセージ受信時のイベントから取得することができます。
コネクションIDをどう取得して管理するかは、ユーザーの実装に委ねられています。
コネクション自体を管理せず、必要なときだけメッセージを送信できるので便利ですね。



# Serverless Framework を使ったサンプルで WebSocket API をデプロイする

今回は [Serverless Framework](https://www.npmjs.com/package/serverless) を使ってサンプル実装を作りました。
[hyiromori/example-aws-api-gateway-websocket](https://github.com/hyiromori/example-aws-api-gateway-websocket)

動くコードは数十行しかない、ごく小さなプロジェクトです。
これを使って、次の「WebSocket API の実験」を行います。

## サンプルコード解説

軽くサンプル実装について解説します。

コアとなる部分は [index.js](https://github.com/hyiromori/example-aws-api-gateway-websocket/blob/main/index.js) の部分です。
ここにメッセージ受信時、接続時、切断時の処理を実装しています。

まずメッセージ受信時の処理です。
ここでは受信したイベントからエンドポイントURLを組み立てて、コネクションIDと共に送信元に返す処理をしています。
このエンドポイントURLとコネクションIDが、WebSocket にメッセージを送信するために必要になります。

```javascript
const onMessage = async (event) => {
  // イベントデータからコネクションのエンドポイントURLを組み立てる
  const { body } = event
  const {connectionId, apiId, stage} = event.requestContext;
  const endpoint = `https://${apiId}.execute-api.${process.env.AWS_REGION}.amazonaws.com/${stage}`

  // 送信元コネクションにエンドポイントURLとコネクションIDを送信する
  const apiGateway = new ApiGatewayManagementApi({apiVersion: '2018-11-29', endpoint})
  const params = {Data: JSON.stringify({endpoint, connectionId, request: body}), ConnectionId: connectionId}
  await apiGateway.postToConnection(params).promise()

  return {}
}
```

接続時と切断時は特に何もしないので、そのまま正常終了させます。
ちなみに接続時と切断時にもエンドポイントURLを組み立てる情報やコネクションIDは含まれているので、ここで必要な処理を実装することもできます。
（今回の実験では使用しないだけです）

```javascript
const mockHandler = (_event, _context, callback) => callback(null, {})
```

あとは [serverless.yml](https://github.com/hyiromori/example-aws-api-gateway-websocket/blob/main/serverless.yml#L24-L38) で `WebSocket API` のイベントと `Lambda` を紐付けます。

```yaml
onConnect:
  handler: "index.onConnect"
  events:
    - websocket:
        route: "$connect"
onMessage:
  handler: "index.onMessage"
  events:
    - websocket:
        route: "$default"
onDisconnect:
  handler: "index.onDisconnect"
  events:
    - websocket:
        route: "$disconnect"
```

## デプロイ

[AWSアクセスキーを設定](https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-configure-files.html) した上で、以下のコマンドを実行するだけで API Gateway の WebSocket API が作成できます。

```bash
$ npm run deploy

(略)
endpoints:
  wss://xxxxxxxxxx.execute-api.(AWS_REGION).amazonaws.com/prod
(略)
```

`wss://....` のURLは、次の「WebSocket API の実験」で使用するのでメモしておきます。



# WebSocket API の実験

デプロイした WebSocket API を使って、どのような挙動をするか確認します。

## Chrome DevTools を使って接続してみる

```javascript
var WebSocketURL = 'wss://xxxxxxxxxx.execute-api.(AWS_REGION).amazonaws.com/prod';
var ws = new WebSocket(WebSocketURL);
ws.onmessage = (messageEvent) => console.debug(JSON.parse(messageEvent.data))
ws.send('{}')
// {endpoint: "https://xxxxxxxxxx.execute-api.(AWS_REGION).amazonaws.com/prod", connectionId: "XXXXXXXXXXXXXXX="}
```

実際に動かすとこのような感じになります。

![DevTools](https://i.gyazo.com/ef1075487ef553d9e0af16cba7e45f78.png)

これで WebSocket API を呼び出して、コネクションを確立し、メッセージを送受信できることが確認できました。
受信したメッセージ内の `endpoint`（エンドポイントURL）と `connectionId`（コネクションID）は次のメッセージ送信で使います。

## AWS CLI を使ってメッセージを送信してみる

AWS CLI から、エンドポイントURLとコネクションIDを使ってメッセージを送信してみましょう。
（※なお時間が立つと WebSocket のコネクションが切断されるので、その場合は再度 DevTools で接続してからすぐ試してみてください）

```bash
$ aws apigatewaymanagementapi post-to-connection \
     --data '{"test":"data"}' \
     --endpoint-url '(endpoint)' \
     --connection-id '(connectionID)'
```

うまくいけば以下のように Chrome DevTools にメッセージが表示されます。

![DevTools](https://i.gyazo.com/e90e51328146eb299f0b7a06f50c1928.png)

これで WebSocket API を使って通信できることを確認できました🎉

## まとめ

- エンドポイントURLとコネクションIDがあれば、AWS CLI や SDK を使って WebSocket にメッセージを送れる。

# タイムアウトの調査

WebSocket がどのぐらいで切断されるのか気になったので調査してみました。

なお私の環境で試した調査結果であり、全ての環境で同じになるかは不明です。
実際に使用する場合は、実行する環境で必ずテストしてください。

## WebSocket のタイムアウト時間

公式ドキュメントを探していたのですが、見つけきれませんでした。
そもそもクライアント側の設定によるものとかもあるかもしれないので、定義できないとかもあるのかもしれません。
（私も WebSocket にあまり詳しくないので、もしこの辺りご存じの方がいれば教えていただきたいです）

ということで、実際に API Gateway と Chrome DevTools で試してみた結果をまとめてみました。

## タイムアウトの調査

WebSocket は `readyState` で現在の状態が入っているので、これで確認できる。
主に `1` が接続状態 `3` が切断済みの状態がわかっていれば大丈夫。
https://developer.mozilla.org/ja/docs/Web/API/WebSocket/readyState

Chrome DevTools で試してみました。
[https://gyazo.com/9eb4cda512f58a8cb6a9b407f9a52b56]

Chrome DevTools のコンソールから実験してみた結果。

```
> let ws = new WebSocket('wss://u3ka4x96a7.execute-api.us-east-1.amazonaws.com/prod')
> (new Date()).toISOString().substr(11, 8)
08:12:53
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:14:53 1
08:14:54 3
```

接続後、１分間何もしないと、コネクションが切断されるみたい。
ただ、一度メッセージを送ると２分に延長されるようです。

```bash
> let ws = new WebSocket('wss://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod')
> ws.send('MESSAGE')
> (new Date()).toISOString().substr(11, 8)
08:23:00
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:25:00 1
08:25:01 3
```

## コネクションを切断されないようにするには？

コネクション確立後に一度メッセージを送信して、その後は2分未満のインターバルで適当なリクエストを送っておくとコネクションが維持できそうな気がしました。
試しに以下のように１分ごとにメッセージを送り続けると、15分以上コネクションが維持できることが確認できました。

```javascript
setInterval(() => ws.send('ping'), 60000)
```



# WebSocket API の料金

WebSocket API は接続時間と、メッセージの送受信量に応じて課金されます

`ap-northeast-1` (Asia/Tokyo) の料金です。
日本円への変換は `$1 = 100円` で計算しています。

最新の正確な料金は以下の公式ドキュメントを確認してください。
[料金 - Amazon API Gateway | AWS](https://aws.amazon.com/jp/api-gateway/pricing/)

## 接続時間に応じた料金

100万分の接続に対して、$0.315かかります。
例えば、１万人のユーザーが、１人あたり月に1000分（約16時間）接続したら、31.5円かかる計算です。
かなり安いですね。

## メッセージの送受信量に応じた料金

メッセージの送受信量は、32KB単位で計算されるようです。
１メッセージを32KB以下であれば、10億回につき$1.26かかります。
例えば、１万人のユーザーが、32KB以下のメッセージを１人あたり月に10万回送受信したら、126円かかる計算です。

なお送受信できる１回のメッセージのサイズは最大128KBです。
