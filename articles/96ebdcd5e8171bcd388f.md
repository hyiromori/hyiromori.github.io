---
title: "AWS API Gateway の WebSocket の仕組みを理解する"
emoji: "👋"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "API Gateway", "WebSocket"]
published: false
---

## はじめに

これは AWS のサービスの一つ、[API Gateway](https://aws.amazon.com/jp/api-gateway/) の [WebSocket](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-websocket-api-overview.html) を理解するために書いた記事です。
[発表当初](https://aws.amazon.com/jp/blogs/news/announcing-websocket-apis-in-amazon-api-gateway/)から個人的に使っているのですが、結局 API Gateway の WebSocket は何を提供してくれて、何を実装しないといけないのかをまとめたいな、と思ったので書きました。



## まとめ

まず API Gateway が管理してくれるものと自分で実装しないといけないものをまとめておきます。

### API Gateway が管理してくれるもの

- WebSocket のコネクション
- WebSocket のイベント/メッセージ受信時にバックエンド（Lambda など）転送

### 自分で実装しないといけないもの

- イベント送信
- イベント/メッセージ受信時のバックエンド（Lambda など）
- 接続の一覧管理（必要であれば）



## サンプル実装の紹介

今回はサンプル実装で挙動を確認しています。
ソースコードは GitHub に置いているので、もし参照したい方はこちらをご覧ください。
[hyiromori/example-aws-api-gateway-websocket](https://github.com/hyiromori/example-aws-api-gateway-websocket)

動くコードは数十行しかない、ごく小さなプロジェクトです。



## 各イベントでの挙動

### 接続時


### メッセージ受信時



### 切断時



## WebSocket のタイムアウト時間

公式ドキュメントを探していたのですが、見つけきれませんでした。
そもそもクライアント側の設定によるものとかもあるかもしれないので、定義できないとかもあるのかもしれません。
（私も WebSocket にあまり詳しくないので、もしこの辺りご存じの方がいれば教えていただきたいです）

ということで、実際に API Gateway と Chrome の開発者コンソールで試してみた結果を Scrapbox にまとめてみました。

### タイムアウトの調査

WebSocket は `readyState` で現在の状態が入っているので、これで確認できる。
主に `1` が接続状態 `3` が切断済みの状態がわかっていれば大丈夫。
https://developer.mozilla.org/ja/docs/Web/API/WebSocket/readyState

Chrome DevTools で試してみました。
[https://gyazo.com/9eb4cda512f58a8cb6a9b407f9a52b56]

Chrome DevTools のコンソールから実験してみた結果。

```text
> let ws = new WebSocket('wss://u3ka4x96a7.execute-api.us-east-1.amazonaws.com/prod')
> (new Date()).toISOString().substr(11, 8)
08:12:53
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:14:53 1
08:14:54 3
```

接続後、１分間何もしないと、コネクションが切断されるみたい。
ただ、一度メッセージを送ると２分に延長されるようです。

```bash
> let ws = new WebSocket('wss://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod')
> ws.send('MESSAGE')
> (new Date()).toISOString().substr(11, 8)
08:23:00
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:25:00 1
08:25:01 3
```

### コネクションを切断されないようにするには？

（※今回の実験の結果であり、全ての環境で同じになるかは不明です。実際に使用する場合は、実行する環境で必ずテストしてください）

コネクション確立後に一度メッセージを送信して、その後は2分未満のインターバルで適当なリクエストを送っておくとコネクションが維持できそうな気がしました。
試しに以下のように１分ごとにメッセージを送り続けると、15分以上コネクションが維持できることが確認できました。

```javascript
setInterval(() => ws.send('ping'), 60000)
```
