---
title: "AWS API Gateway の WebSocket API を理解する"
emoji: "⚡️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS", "APIGateway", "WebSocket"]
published: false
---

## はじめに

これは AWS のサービスの一つ、[API Gateway](https://aws.amazon.com/jp/api-gateway/) の [WebSocket API](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-websocket-api-overview.html) を理解するために書いた記事です。
[発表当初](https://aws.amazon.com/jp/blogs/news/announcing-websocket-apis-in-amazon-api-gateway/)から個人的に色々試してはいたのですが、一度ちゃんとまとめたいなと思って書いた記事です。


# WebSocket API が提供してくれるもの

## サーバー管理不要で WebSocket コネクションを管理できる

## コネクションイベントとメッセージ受信時のバックエンド転送



# Serverless Framework を使って WebSocket API をデプロイする

## サンプルコード解説

今回はサンプル実装で挙動を確認しています。
ソースコードは GitHub に置いているので、もし参照したい方はこちらをご覧ください。

[hyiromori/example-aws-api-gateway-websocket](https://github.com/hyiromori/example-aws-api-gateway-websocket)

動くコードは数十行しかない、ごく小さなプロジェクトです。

## デプロイ



# WebSocket API の実験

## Chrome DevTools を使って接続してみる

## AWS CLI を使ってメッセージを送信してみる

## タイムアウトの調査

### WebSocket のタイムアウト時間

公式ドキュメントを探していたのですが、見つけきれませんでした。
そもそもクライアント側の設定によるものとかもあるかもしれないので、定義できないとかもあるのかもしれません。
（私も WebSocket にあまり詳しくないので、もしこの辺りご存じの方がいれば教えていただきたいです）

ということで、実際に API Gateway と Chrome DevTools で試してみた結果をまとめてみました。

#### タイムアウトの調査

WebSocket は `readyState` で現在の状態が入っているので、これで確認できる。
主に `1` が接続状態 `3` が切断済みの状態がわかっていれば大丈夫。
https://developer.mozilla.org/ja/docs/Web/API/WebSocket/readyState

Chrome DevTools で試してみました。
[https://gyazo.com/9eb4cda512f58a8cb6a9b407f9a52b56]

Chrome DevTools のコンソールから実験してみた結果。

```
> let ws = new WebSocket('wss://u3ka4x96a7.execute-api.us-east-1.amazonaws.com/prod')
> (new Date()).toISOString().substr(11, 8)
08:12:53
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:14:53 1
08:14:54 3
```

接続後、１分間何もしないと、コネクションが切断されるみたい。
ただ、一度メッセージを送ると２分に延長されるようです。

```bash
> let ws = new WebSocket('wss://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod')
> ws.send('MESSAGE')
> (new Date()).toISOString().substr(11, 8)
08:23:00
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(省略)
08:25:00 1
08:25:01 3
```

### コネクションを切断されないようにするには？

（※今回の実験の結果であり、全ての環境で同じになるかは不明です。実際に使用する場合は、実行する環境で必ずテストしてください）

コネクション確立後に一度メッセージを送信して、その後は2分未満のインターバルで適当なリクエストを送っておくとコネクションが維持できそうな気がしました。
試しに以下のように１分ごとにメッセージを送り続けると、15分以上コネクションが維持できることが確認できました。

```javascript
setInterval(() => ws.send('ping'), 60000)
```



# WebSocket API の料金

WebSocket API は接続時間と、メッセージの送受信量に応じて課金されます

`ap-northeast-1` (Asia/Tokyo) の料金です。
日本円への変換は `$1 = 100円` で計算しています。

最新の正確な料金は以下の公式ドキュメントを確認してください。
[料金 - Amazon API Gateway | AWS](https://aws.amazon.com/jp/api-gateway/pricing/)

## 接続時間に応じた料金

100万分の接続に対して、$0.315かかります。
例えば、１万人のユーザーが、１人あたり月に1000分（約16時間）接続したら、31.5円かかる計算です。
かなり安いですね。

## メッセージの送受信量に応じた料金

メッセージの送受信量は、32KB単位で計算されるようです。
１メッセージを32KB以下であれば、10億回につき$1.26かかります。
例えば、１万人のユーザーが、32KB以下のメッセージを１人あたり月に10万回送受信したら、126円かかる計算です。

なお送受信できる１回のメッセージのサイズは最大128KBです。
